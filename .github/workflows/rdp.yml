name: Free RDP Tunnel - Working

on:
  workflow_dispatch:
  push:
    branches: [main, master]

env:
  RDP_USER: "RDPAdmin"
  RDP_PASS: "P@ssw0rd123!"

jobs:
  rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 355

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Enable RDP Service
      run: |
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
        net start TermService

    - name: Create User Account
      run: |
        net user "$env:RDP_USER" "$env:RDP_PASS" /add /Y
        net localgroup administrators "$env:RDP_USER" /add
        net localgroup "Remote Desktop Users" "$env:RDP_USER" /add

    - name: Start Serveo Tunnel (Primary - Working)
      run: |
        $Port = Get-Random -Minimum 40000 -Maximum 50000
        Write-Output "üéØ YOUR RDP CONNECTION URL: serveo.net:$Port"
        Write-Output "üîë Username: $env:RDP_USER"
        Write-Output "üîí Password: $env:RDP_PASS"
        
        # Start Serveo tunnel in background
        Start-Job -ScriptBlock {
            param($Port)
            while ($true) {
                try {
                    ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -R $Port:localhost:3389 serveo.net
                    Start-Sleep 5
                } catch {
                    Write-Output "Tunnel reconnect attempt..."
                    Start-Sleep 10
                }
            }
        } -ArgumentList $Port

    - name: Start Cloudflared (Backup)
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -o cloudflared.exe
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url rdp://localhost:3389" -WindowStyle Hidden

    - name: Wait for Tunnel Initialization
      run: |
        Write-Output "‚è≥ Waiting 60 seconds for tunnels to initialize..."
        Start-Sleep -Seconds 60
        Write-Output "‚úÖ Tunnels should be active now"

    - name: Display Connection Information
      run: |
        Write-Output ""
        Write-Output "========================================"
        Write-Output "        RDP TUNNEL READY - WORKING"
        Write-Output "========================================"
        Write-Output "üåê PRIMARY URL (SERVEO): serveo.net:[PORT]"
        Write-Output "   Check above for exact port number"
        Write-Output ""
        Write-Output "üîß ALTERNATIVE METHODS:"
        Write-Output "1. Try different port if first fails"
        Write-Output "2. Cloudflared backup (check logs)"
        Write-Output ""
        Write-Output "üë§ CREDENTIALS:"
        Write-Output "Username: $env:RDP_USER"
        Write-Output "Password: $env:RDP_PASS"
        Write-Output ""
        Write-Output "üöÄ CONNECTION STEPS:"
        Write-Output "1. Remote Desktop Connection (mstsc)"
        Write-Output "2. Computer: serveo.net:PORT"
        Write-Output "3. Use credentials above"
        Write-Output "4. Accept certificate warning"
        Write-Output "========================================"

    - name: Maintain Session
      run: |
        Write-Output "üîÑ 6-hour RDP session active..."
        $StartTime = Get-Date
        for ($i = 1; $i -le 350; $i++) {
            $Elapsed = [math]::Round($i / 60, 1)
            Write-Output "‚è±Ô∏è  Active: $i minutes ($Elapsed hours) - serveo.net tunnel running"
            Start-Sleep -Seconds 60
        }
