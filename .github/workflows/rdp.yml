name: RDP Tunnel - Complete

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 355

    steps:
    - name: Enable RDP Service
      run: reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

    - name: Configure Firewall
      run: netsh advfirewall firewall set rule group "remote desktop" new enable=Yes

    - name: Create User Account
      run: net user RDPUser P@ssw0rd123! /add /Y

    - name: Add to Admin Group
      run: net localgroup administrators RDPUser /add

    - name: Add to RDP Group
      run: net localgroup "Remote Desktop Users" RDPUser /add

    - name: Download FRP Tunnel
      run: |
        curl -L https://github.com/fatedier/frp/releases/download/v0.52.3/frp_0.52.3_windows_amd64.zip -o frp.zip
        tar -xf frp.zip

    - name: Create FRP Config
      run: |
        echo [common] > frp_0.52.3_windows_amd64/frpc.ini
        echo server_addr = free.frp.net >> frp_0.52.3_windows_amd64/frpc.ini
        echo server_port = 7000 >> frp_0.52.3_windows_amd64/frpc.ini
        echo [rdp] >> frp_0.52.3_windows_amd64/frpc.ini
        echo type = tcp >> frp_0.52.3_windows_amd64/frpc.ini
        echo local_ip = 127.0.0.1 >> frp_0.52.3_windows_amd64/frpc.ini
        echo local_port = 3389 >> frp_0.52.3_windows_amd64/frpc.ini
        echo remote_port = 13389 >> frp_0.52.3_windows_amd64/frpc.ini

    - name: Start FRP Tunnel
      run: |
        cd frp_0.52.3_windows_amd64
        Start-Process -FilePath "frpc.exe" -ArgumentList "-c frpc.ini" -WindowStyle Hidden
        cd ..

    - name: Display Connection Info
      run: |
        echo "========================================"
        echo "           RDP TUNNEL READY"
        echo "========================================"
        echo "URL: free.frp.net:13389"
        echo "Username: RDPUser"
        echo "Password: P@ssw0rd123!"
        echo ""
        echo "Connection Steps:"
        echo "1. Remote Desktop Connection"
        echo "2. Computer: free.frp.net:13389"
        echo "3. Use credentials above"
        echo "4. Accept certificate warning"
        echo "========================================"

    - name: Wait for Tunnel
      run: |
        Start-Sleep -Seconds 30
        echo "Tunnel should be active now"

    - name: Maintain Session
      run: |
        $counter = 1
        while ($counter -le 350) {
            if ($counter % 10 -eq 0) {
                $hours = [math]::Round($counter / 60, 1)
                echo "RDP active: $counter minutes ($hours hours)"
            }
            Start-Sleep -Seconds 60
            $counter++
        }
        echo "6-hour session complete"
