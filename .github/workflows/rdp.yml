name: Free RDP Tunnel

on:
  workflow_dispatch:
  push:
    branches: [main, master]

env:
  RDP_USER: "RDPAdmin"
  RDP_PASS: "P@ssw0rd123!"

jobs:
  rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 355

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Enable RDP
      run: |
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes

    - name: Create User
      run: |
        net user "$env:RDP_USER" "$env:RDP_PASS" /add /Y
        net localgroup administrators "$env:RDP_USER" /add
        net localgroup "Remote Desktop Users" "$env:RDP_USER" /add

    - name: Download Cloudflared
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -o cloudflared.exe

    - name: Start Tunnel
      run: |
        $TunnelID = Get-Random -Minimum 1000 -Maximum 9999
        Write-Output "YOUR RDP URL: rdp-$TunnelID.trycloudflare.com"
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url rdp://localhost:3389" -WindowStyle Hidden

    - name: Display Info
      run: |
        Write-Output "========================================"
        Write-Output "           RDP READY"
        Write-Output "========================================"
        Write-Output "URL: Check logs above for Cloudflared URL"
        Write-Output "User: $env:RDP_USER"
        Write-Output "Pass: $env:RDP_PASS"
        Write-Output "Duration: 6 hours"
        Write-Output "========================================"

    - name: Wait for Tunnels
      run: |
        Start-Sleep -Seconds 30
        Write-Output "Tunnels active - Ready for connections"

    - name: Keep Alive
      run: |
        Write-Output "RDP session running for 6 hours..."
        $StartTime = Get-Date
        for ($i = 1; $i -le 350; $i++) {
            $Elapsed = [math]::Round($i / 60, 1)
            Write-Output "Active: $i minutes ($Elapsed hours)"
            Start-Sleep -Seconds 60
        }
