name: RDP Tunnel - Modern

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 355

    steps:
    - name: Enable RDP Service
      run: |
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group "remote desktop" new enable=Yes
        net start TermService
        Write-Output "âœ… RDP service enabled"

    - name: Create User Account
      run: |
        net user RDPUser P@ssw0rd123! /add /Y
        net localgroup administrators RDPUser /add
        net localgroup "Remote Desktop Users" RDPUser /add
        Write-Output "âœ… User account created"

    - name: Download Cloudflared
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -o cloudflared.exe
        Write-Output "âœ… Cloudflared downloaded"

    - name: Start Cloudflared Tunnel
      run: |
        $RandomID = Get-Random -Minimum 1000 -Maximum 9999
        Write-Output "ğŸ¯ YOUR RDP URL: rdp-$RandomID.trycloudflare.com:3389"
        Write-Output "ğŸ‘¤ USERNAME: RDPUser"
        Write-Output "ğŸ”‘ PASSWORD: P@ssw0rd123!"
        
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url rdp://localhost:3389" -WindowStyle Hidden
        Write-Output "âœ… Cloudflared tunnel started"

    - name: Wait for Tunnel Initialization
      run: |
        Write-Output "â³ Waiting 60 seconds for tunnel to initialize..."
        Start-Sleep -Seconds 60
        Write-Output "âœ… Tunnel should be active now"

    - name: Display Connection Instructions
      run: |
        Write-Output ""
        Write-Output "========================================"
        Write-Output "         RDP TUNNEL READY"
        Write-Output "========================================"
        Write-Output "ğŸŒ CONNECTION URL: Use the URL above"
        Write-Output "   Format: rdp-XXXX.trycloudflare.com:3389"
        Write-Output ""
        Write-Output "ğŸ‘¤ CREDENTIALS:"
        Write-Output "Username: RDPUser"
        Write-Output "Password: P@ssw0rd123!"
        Write-Output ""
        Write-Output "ğŸš€ CONNECTION STEPS:"
        Write-Output "1. Open Remote Desktop Connection"
        Write-Output "2. Enter the URL from above"
        Write-Output "3. Use credentials above"
        Write-Output "4. Accept certificate warning"
        Write-Output ""
        Write-Output "â° DURATION: 6 hours"
        Write-Output "========================================"

    - name: Maintain RDP Session
      run: |
        Write-Output "ğŸ”„ RDP session active for 6 hours..."
        $StartTime = Get-Date
        
        for ($minute = 1; $minute -le 350; $minute++) {
            $Elapsed = [math]::Round($minute / 60, 1)
            
            if ($minute % 10 -eq 0) {
                Write-Output "âœ… Session active: $minute minutes ($Elapsed hours)"
                
                # Simple health check
                $RDPStatus = Get-Service TermService
                if ($RDPStatus.Status -ne "Running") {
                    net start TermService
                    Write-Output "ğŸ”„ RDP service restarted"
                }
            }
            
            Start-Sleep -Seconds 60
        }
        
        Write-Output "â° 6-hour session complete"
