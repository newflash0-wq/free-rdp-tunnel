name: Free RDP Tunnel - Enhanced URL Display

on:
  workflow_dispatch:
  push:
    branches: [main, master]

env:
  RDP_USER: "RDPAdmin"
  RDP_PASS: "P@ssw0rd123!Complex"

jobs:
  rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 355

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Enable and Configure RDP
      run: |
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes

    - name: Create RDP User
      run: |
        net user "$env:RDP_USER" "$env:RDP_PASS" /add /Y
        net localgroup administrators "$env:RDP_USER" /add
        net localgroup "Remote Desktop Users" "$env:RDP_USER" /add

    - name: Download and Start Cloudflared with Clear URL
      run: |
        # Download cloudflared
        curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -o cloudflared.exe
        
        # Generate unique subdomain
        $RandomID = Get-Random -Minimum 1000 -Maximum 9999
        $TunnelURL = "rdp-$RandomID.trycloudflare.com"
        
        Write-Output "=========================================="
        Write-Output "üéØ YOUR RDP TUNNEL URL: $TunnelURL"
        Write-Output "=========================================="
        
        # Start cloudflared with explicit URL
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url rdp://localhost:3389 --hostname $TunnelURL" -WindowStyle Hidden
        
        Write-Output "‚è≥ Tunnel initializing... wait 30 seconds"

    - name: Start Serveo with Visible URL
      run: |
        $ServeoPort = Get-Random -Minimum 40000 -Maximum 50000
        Write-Output "=========================================="
        Write-Output "üîó SERVEO BACKUP URL: serveo.net:$ServeoPort"
        Write-Output "=========================================="
        
        Start-Job -ScriptBlock {
            param($Port)
            ssh -o StrictHostKeyChecking=no -R $Port`:localhost:3389 serveo.net
        } -ArgumentList $ServeoPort

    - name: Wait for Tunnel Initialization
      run: |
        Write-Output "‚è∞ Waiting for tunnels to initialize..."
        Start-Sleep -Seconds 30
        Write-Output "‚úÖ Tunnels should be active now"

    - name: Display Clear Connection Instructions
      run: |
        $RandomID = Get-Random -Minimum 1000 -Maximum 9999
        Write-Output ""
        Write-Output "üéØüéØüéØ COPY THIS INFORMATION üéØüéØüéØ"
        Write-Output "=========================================="
        Write-Output "üåê RDP CONNECTION URLs:"
        Write-Output "PRIMARY: rdp-$RandomID.trycloudflare.com:3389"
        Write-Output "BACKUP: serveo.net:$(Get-Random -Minimum 40000 -Maximum 50000)"
        Write-Output ""
        Write-Output "üë§ LOGIN CREDENTIALS:"
        Write-Output "Username: $env:RDP_USER"
        Write-Output "Password: $env:RDP_PASS"
        Write-Output ""
        Write-Output "üöÄ CONNECTION STEPS:"
        Write-Output "1. Open Remote Desktop Connection (mstsc)"
        Write-Output "2. Paste URL above"
        Write-Output "3. Use credentials above"
        Write-Output "4. Accept certificate warning"
        Write-Output ""
        Write-Output "‚è∞ SESSION DURATION: 6 HOURS"
        Write-Output "=========================================="

    - name: Monitor and Maintain Session
      run: |
        Write-Output "üîÑ RDP Session Active - Monitoring..."
        $StartTime = Get-Date
        for ($i = 1; $i -le 355; $i++) {
            $Elapsed = [math]::Round(($i / 60), 1)
            Write-Output "‚è±Ô∏è  Session active: $i minutes ($Elapsed hours) - URLs remain valid"
            if (($i % 10) -eq 0) {
                Write-Output "üîç Quick health check: RDP service running"
                Get-Service TermService | Select-Object Status, Name
            }
            Start-Sleep -Seconds 60
        }
